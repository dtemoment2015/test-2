# Тестовое задание Laravel API

API для загрузки и управления изображениями с авторизацией.

## Деплой через Laravel Sail

1. Клонируйте репозиторий:
```bash
git clone git@github.com:dtemoment2015/test-2.git
cd test-2
```

2. Установите зависимости:
```bash
composer install
```

3. Скопируйте файл окружения:
```bash
cp .env.example .env
```

4. Сгенерируйте ключ приложения:
```bash
php artisan key:generate
```

5. Запустите Docker контейнеры:
```bash
./vendor/bin/sail up -d
```

Если порты заняты, можно изменить переменные в `.env` файле:
- `APP_PORT` (по умолчанию 80) - порт приложения
- `VITE_PORT` (по умолчанию 5173) - порт для Vite
- `FORWARD_DB_PORT` - порт для MySQL или PG

6. Выполните миграции:
```bash
./vendor/bin/sail artisan migrate
```

7. Создайте символическую ссылку для хранения файлов в Storage:
```bash
./vendor/bin/sail artisan storage:link
```

8. Сгенерируйте документацию API:
```bash
./vendor/bin/sail artisan scribe:generate
```

После этого API будет доступно по адресу `http://localhost:{PORT}/api/v1`

Документация API доступна по адресу: `http://localhost:{PORT}/docs`

## Установка зависимостей для работы с изображениями

Вообще я обычно для работы с изображениями использую Spatie Media Library. В данном тестовом задании для сжатия изображений используется библиотека Intervention Image:

```bash
composer require intervention/image
```

## API Endpoints

### Авторизация

- `POST /api/v1/register` - Регистрация нового пользователя

- `POST /api/v1/login` - Вход в систему

- `POST /api/v1/logout` - Выход из системы (требует авторизации)

### Изображения (требуют авторизации)

- `POST /api/v1/images` - Загрузка изображения

- `GET /api/v1/images` - Список загруженных изображений пользователя

- `GET /api/v1/images/{id}` - Получение изображения по ID

- `DELETE /api/v1/images/{id}` - Удаление изображения

## Структура проекта

Проект разделен на слои.

**Routes (Маршруты)** - определяют URL и контроллеры. Роуты в `routes/api.php`.

**Controllers (Контроллеры)** - принимают запросы, вызывают сервисы. Логика в сервисах.

**Requests (Запросы)** - валидация входящих данных. Проверяют поля и форматы.

**DTOs (Data Transfer Objects)** - объекты передачи данных. Для создания и обновления.

**Resources (Ресурсы)** - форматируют данные в JSON. С курсорной пагинацией.

**Services (Сервисы)** - бизнес-логика приложения. Используют репозитории.

**Repositories (Репозитории)** - работа с базой через модели. Интерфейсы и реализации.

**Models (Модели)** - Eloquent модели, структура таблиц.

## Структура базы данных

Две основные таблицы: `users`, `images`.

Изображения привязаны к пользователям через `user_id`.

## Особенности реализации

- **Авторизация**: Используется Laravel Sanctum для API токенов
- **Валидация файлов**: Только PNG и JPEG, максимальный размер 5MB
- **Сжатие изображений**: Автоматическое сжатие до 1920px с сохранением качества (85% для JPEG)
- **Дедупликация**: Проверка хеша файла (SHA256) для избежания дублирования
- **Курсорная пагинация**: Для списка изображений
- **Изоляция данных**: Пользователи видят только свои изображения
- **Оптимизация хранения**: Одинаковые файлы хранятся один раз, используется ссылка

